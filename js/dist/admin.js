(()=>{var t={n:n=>{var s=n&&n.__esModule?()=>n.default:()=>n;return t.d(s,{a:s}),s},d:(n,s)=>{for(var a in s)t.o(s,a)&&!t.o(n,a)&&Object.defineProperty(n,a,{enumerable:!0,get:s[a]})},o:(t,n)=>Object.prototype.hasOwnProperty.call(t,n),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},n={};(()=>{"use strict";t.r(n);const s=flarum.core.compat["admin/app"];var a=t.n(s);const e=flarum.core.compat["common/Model"];var i=t.n(e);function o(t,n){return o=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t},o(t,n)}function r(t,n){t.prototype=Object.create(n.prototype),t.prototype.constructor=t,o(t,n)}const d=flarum.core.compat["common/utils/mixin"];var l=function(t){function n(){return t.apply(this,arguments)||this}return r(n,t),n.prototype.apiEndpoint=function(){return"/fof/ban-ips"+(this.exists?"/"+this.id():"")},n}(t.n(d)()(i(),{creator:i().hasOne("creator"),user:i().hasOne("user"),address:i().attribute("address"),reason:i().attribute("reason"),createdAt:i().attribute("createdAt",i().transformDate),deletedAt:i().attribute("deletedAt",i().transformDate)}));const p=flarum.core.compat["common/components/Button"];var u=t.n(p);const h=flarum.core.compat["common/components/LoadingIndicator"];var c=t.n(h);const b=flarum.core.compat["common/components/Placeholder"];var f=t.n(b);const g=flarum.core.compat["admin/components/ExtensionPage"];var v=t.n(g);const _=flarum.core.compat["common/components/Modal"];var y=t.n(_);const N=flarum.core.compat["common/components/Alert"];var O=t.n(N);const A=flarum.core.compat["common/helpers/punctuateSeries"];var P=t.n(A);const B=flarum.core.compat["common/helpers/username"];var F=t.n(B);const x=flarum.core.compat["common/utils/Stream"];var I=t.n(x),U=function(t){function n(){return t.apply(this,arguments)||this}r(n,t);var s=n.prototype;return s.oninit=function(n){t.prototype.oninit.call(this,n),this.address=I()(""),this.reason=I()(""),this.usersBanned={},this.loading=!1},s.className=function(){return"Modal--medium"},s.title=function(){return a().translator.trans("fof-ban-ips.lib.modal.title")},s.content=function(){var t=this.usersBanned[this.address()],n=t&&t.map(F());return m("div",{className:"Modal-body"},m("p",null,a().translator.trans("fof-ban-ips.lib.modal.ban_ip_confirmation")),m("div",{className:"Form-group"},m("label",{className:"label"},a().translator.trans("fof-ban-ips.lib.modal.address_label")),m("input",{type:"text",className:"FormControl",bidi:this.address,required:!0,pattern:"^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$|^(([a-zA-Z]|[a-zA-Z][a-zA-Z0-9\\-]*[a-zA-Z0-9])\\.)*([A-Za-z]|[A-Za-z][A-Za-z0-9\\-]*[A-Za-z0-9])$|^\\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:)))(%.+)?\\s*$"})),m("div",{className:"Form-group"},m("label",{className:"label"},a().translator.trans("fof-ban-ips.lib.modal.reason_label")),m("input",{type:"text",className:"FormControl",bidi:this.reason})),t?t.length?O().component({dismissible:!1},a().translator.trans("fof-ban-ips.lib.modal.ban_ip_users",{users:P()(n),count:n.length})):O().component({dismissible:!1,type:"success"},a().translator.trans("fof-ban-ips.admin.modal.ban_ip_no_users")):"",t&&m("br",null),m("div",{className:"Form-group"},m(u(),{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:a().store.getBy("banned_ips","address",this.address())},n?a().translator.trans("fof-ban-ips.lib.modal.ban_button"):a().translator.trans("fof-ban-ips.lib.modal.check_button"))))},s.onsubmit=function(t){if(t.preventDefault(),this.address()){if(this.loading=!0,void 0===this.usersBanned[this.address()])return this.getOtherUsers();var n={address:this.address(),reason:this.reason()};a().store.createRecord("banned_ips").save(n).then(this.hide.bind(this),this.onerror.bind(this),this.loaded.bind(this))}},s.getOtherUsers=function(){var t=this,n={ip:this.address()};a().request({params:n,url:a().forum.attribute("apiUrl")+"/fof/ban-ips/check-users",method:"GET"}).then((function(n){t.usersBanned[t.address()]=n.data.map((function(t){return a().store.pushObject(t)})),m.redraw()})).then(this.loaded.bind(this)).catch((function(n){t.onerror(n),t.loading=!1}))},n}(y());const k=flarum.core.compat["common/Component"];var M=t.n(k);const S=flarum.core.compat["common/app"];var w=t.n(S),z=function(t){function n(){return t.apply(this,arguments)||this}r(n,t);var s=n.prototype;return s.oninit=function(n){if(t.prototype.oninit.call(this,n),this.address=this.attrs.address,this.post=this.attrs.post,this.user=this.attrs.user||this.post&&this.post.user(),!this.user&&this.address){var s=w().store.getBy("banned_ips","address",this.address);s&&(this.user=s.user())}this.banOptions=[],(this.post&&this.post.ipAddress()||this.address)&&this.banOptions.push("only"),this.user&&this.banOptions.push("all"),this.banOption=I()(this.banOptions[0]),this.reason=I()(""),this.otherUsers={},this.loading=!1},s.className=function(){return"Modal--medium"},s.title=function(){return w().translator.trans("fof-ban-ips.lib.modal.title")},s.content=function(){var t=this,n=this.otherUsers[this.banOption()],s=n&&n.map((function(t){return t&&t.displayName()||w().translator.trans("core.lib.username.deleted_text")}));return m("div",{className:"Modal-body"},m("p",null,w().translator.trans("fof-ban-ips.lib.modal.ban_ip_confirmation")),m("div",{className:"Form-group"},this.banOptions.map((function(n){return m("div",null,m("input",{type:"radio",name:"ban-option",id:"ban-option-"+n,checked:t.banOption()===n,onclick:t.banOption.bind(t,n)})," ",m("label",{htmlFor:"ban-option-"+n},w().translator.trans("fof-ban-ips.forum.modal.ban_options_"+n+"_ip",{user:t.user,ip:t.address||t.post&&t.post.ipAddress()})))}))),m("div",{className:"Form-group"},m("label",{className:"label"},w().translator.trans("fof-ban-ips.lib.modal.reason_label")),m("input",{type:"text",className:"FormControl",bidi:this.reason})),n?n.length?O().component({dismissible:!1},w().translator.trans("fof-ban-ips.lib.modal.ban_ip_users",{users:P()(s),count:s.length})):O().component({dismissible:!1,type:"success"},w().translator.trans("fof-ban-ips.forum.modal.ban_ip_no_users")):"",n&&m("br",null),m("div",{className:"Form-group"},m(u(),{className:"Button Button--primary",type:"submit",loading:this.loading},s?w().translator.trans("fof-ban-ips.lib.modal.ban_button"):w().translator.trans("fof-ban-ips.lib.modal.check_button"))))},s.onsubmit=function(t){var n=this;if(t.preventDefault(),this.loading=!0,void 0===this.otherUsers[this.banOption()])return this.getOtherUsers();var s={reason:this.reason(),userId:this.user.id()};"only"===this.banOption()?(s.address=this.post.ipAddress(),w().store.createRecord("banned_ips").save(s).then(this.hide.bind(this)).catch(this.onerror.bind(this)).then(this.loaded.bind(this))):"all"===this.banOption()&&w().request({body:{data:{attributes:s}},url:""+w().forum.attribute("apiUrl")+this.user.apiEndpoint()+"/ban",method:"POST",errorHandler:this.onerror.bind(this)}).then((function(t){return w().store.pushPayload(t).forEach(n.done.bind(n))})).then(this.hide.bind(this)).catch((function(){})).then(this.loaded.bind(this))},s.getOtherUsers=function(){var t=this,n={};"only"===this.banOption()&&(n.ip=this.address||this.post.ipAddress()),w().request({params:n,url:w().forum.attribute("apiUrl")+"/fof/ban-ips/check-users/"+this.user.id(),method:"GET",errorHandler:this.onerror.bind(this)}).then((function(n){t.otherUsers[t.banOption()]=n.data.map((function(t){return w().store.pushObject(t)})).filter((function(t){return 0===t.bannedIPs().length})),t.loading=!1})).catch((function(){})).then(this.loaded.bind(this))},s.done=function(t){var n={type:"banned_ips",id:t.id()};this.post&&(this.post.data.relationships.banned_ip={data:n}),this.user.data.relationships.banned_ips||(this.user.data.relationships.banned_ips={data:[]}),this.user.data.relationships.banned_ips.data.push(n),this.user.data.attributes.isBanned=!0,w().store.pushObject(this.user.data)},n}(y()),R=function(t){function n(){return t.apply(this,arguments)||this}r(n,t);var s=n.prototype;return s.title=function(){return w().translator.trans("fof-ban-ips.lib.modal.unban_title")},s.content=function(){var t=this,n=this.otherUsers[this.banOption()],s=n&&n.map((function(t){return t&&t.displayName()||w().translator.trans("core.lib.username.deleted_text")}));return this.bannedIPs?m("div",{className:"Modal-body"},O().component({dismissible:!1,type:"success"},w().translator.trans("fof-ban-ips.lib.modal.unbanned_ips",{ips:P()(this.bannedIPs)}))):m("div",{className:"Modal-body"},m("p",null,w().translator.trans("fof-ban-ips.lib.modal.unban_ip_confirmation")),m("div",{className:"Form-group"},this.banOptions.map((function(n){return m("div",null,m("input",{type:"radio",name:"ban-option",id:"ban-option-"+n,checked:t.banOption()===n,onclick:t.banOption.bind(t,n)})," ",m("label",{htmlFor:"ban-option-"+n},w().translator.trans("fof-ban-ips.lib.modal.unban_options_"+n+"_ip",{user:t.user,ip:t.address||t.post&&t.post.ipAddress()})))}))),n?n.length?O().component({dismissible:!1},w().translator.trans("fof-ban-ips.lib.modal.unban_ip_users",{users:P()(s),count:s.length})):O().component({dismissible:!1,type:"success"},w().translator.trans("fof-ban-ips.lib.modal.unban_ip_no_users")):"",n&&m("br",null),m("div",{className:"Form-group"},m(u(),{className:"Button Button--primary",type:"submit",loading:this.loading},s?w().translator.trans("fof-ban-ips.lib.modal.unban_button"):w().translator.trans("fof-ban-ips.lib.modal.check_button"))))},s.onsubmit=function(t){if(t.preventDefault(),this.loading=!0,void 0===this.otherUsers[this.banOption()])return this.getOtherUsers();var n={};if("only"===this.banOption()){n.address=this.address||this.post.ipAddress();var s=this.post?this.post.bannedIP():w().store.getBy("banned_ips","address",this.address);s.delete().then(this.done.bind(this,s)).catch(this.onerror.bind(this)).then(this.hide.bind(this))}else"all"===this.banOption()&&w().request({body:{data:{attributes:n}},url:""+w().forum.attribute("apiUrl")+this.user.apiEndpoint()+"/unban",method:"POST",errorHandler:this.onerror.bind(this)}).then(this.done.bind(this)).catch(this.onerror.bind(this)).then(this.hide.bind(this))},s.getOtherUsers=function(){var t=this,n={};"only"===this.banOption()&&(n.ip=this.address||this.post.ipAddress(),n.skipValidation=!0);var s=w().forum.attribute("apiUrl")+"/fof/ban-ips/check-users";this.user&&(s+="/"+this.user.id()),w().request({params:n,url:s,method:"GET",errorHandler:this.onerror.bind(this)}).then((function(n){var s=w().store.pushPayload(n);t.otherUsers[t.banOption()]=s.filter((function(t){return 1===t.bannedIPs().length})),t.loading=!1,m.redraw()})).catch((function(){})).then(this.loaded.bind(this))},s.done=function(t){this.loading=!1,this.post&&delete this.post.data.relationships.banned_ip,!this.user||this.user.data.relationships||t?this.user&&t instanceof w().store.models.banned_ips&&(this.user.data.relationships.banned_ips={data:this.user.data.relationships.banned_ips.data.filter((function(n){return n.id!==t.id()}))},this.user.data.attributes.isBanned=0!==this.user.data.relationships.banned_ips.data.length):(this.user.data.relationships.banned_ips.data=[],this.user.data.attributes.isBanned=!1),t&&Array.isArray(t.data)&&(this.bannedIPs=t.data.map((function(t){return t.attributes.address})),this.loading=!1,m.redraw())},s.hide=function(){t.prototype.hide.call(this),this.attrs.redraw||location.reload()},n}(z),j=function(t){function n(){return t.apply(this,arguments)||this}r(n,t);var s=n.prototype;return s.oninit=function(n){t.prototype.oninit.call(this,n),this.item=this.attrs.item,this.reason=I()(this.item.reason())},s.className=function(){return"Modal--medium"},s.title=function(){return a().translator.trans("fof-ban-ips.admin.modal.update_title")},s.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form-group"},m("label",{className:"label"},a().translator.trans("fof-ban-ips.lib.modal.reason_label")),m("input",{type:"text",className:"FormControl",bidi:this.reason})),m("div",{className:"Form-group"},m(u(),{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:this.reason()===this.item.reason()},a().translator.trans("fof-ban-ips.lib.modal.save_button"))))},s.onsubmit=function(t){t.preventDefault(),this.reason()&&(this.loading=!0,this.item.save({reason:this.reason()}).then(this.hide.bind(this)).catch(this.onerror.bind(this)).then(this.loaded.bind(this)))},n}(y()),D=function(t){function n(){return t.apply(this,arguments)||this}r(n,t);var s=n.prototype;return s.oninit=function(n){t.prototype.oninit.call(this,n),this.item=this.attrs.bannedIP},s.view=function(){var t=this;return m("tr",null,m("td",null,this.item.id()),m("td",null,F()(this.item.creator())),m("td",null,this.item.user()&&F()(this.item.user())),m("td",null,this.item.address()),m("td",null,this.item.reason()),m("td",null,this.item.createdAt().toLocaleDateString()),m("td",null,m("div",{className:"Button--group"},u().component({className:"Button Button--warning",icon:"fas fa-pencil-alt",disabled:this.item.creator()!==a().session.user,onclick:function(){return a().modal.show(j,{item:t.item})}}),u().component({className:"Button Button--danger",icon:"fas fa-times",onclick:function(){return a().modal.show(R,{address:t.item.address(),redraw:!0})}}))))},n}(M()),E=function(t){function n(){return t.apply(this,arguments)||this}r(n,t);var s=n.prototype;return s.oninit=function(n){t.prototype.oninit.call(this,n),this.loading=!0,this.page=0,this.pageSize=20},s.oncreate=function(n){t.prototype.oncreate.call(this,n),this.refresh()},s.content=function(){var t,n;return!0===this.nextResults&&(t=u().component({className:"Button Button--PageList-next",icon:"fas fa-angle-right",onclick:this.loadNext.bind(this)})),!0===this.prevResults&&(n=u().component({className:"Button Button--PageList-prev",icon:"fas fa-angle-left",onclick:this.loadPrev.bind(this)})),m("div",{className:"BannedIPsPage"},m("div",{className:"BannedIPsPage-header"},m("div",{className:"container"},u().component({className:"Button Button--primary",icon:"fas fa-plus",onclick:function(){return a().modal.show(U)}},a().translator.trans("fof-ban-ips.admin.page.create_button")))),m("br",null),m("div",{className:"BannedIpsPage-table"},m("div",{className:"container"},this.loading?c().component():a().store.all("banned_ips").length?m("table",{style:{width:"100%",textAlign:"left"},className:"table"},m("thead",null,m("tr",null,m("th",null,"#"),m("th",null,a().translator.trans("fof-ban-ips.admin.page.creator_label")),m("th",null,a().translator.trans("fof-ban-ips.admin.page.user_label")),m("th",null,a().translator.trans("fof-ban-ips.admin.page.address_label")),m("th",null,a().translator.trans("fof-ban-ips.admin.page.reason_label")),m("th",null,a().translator.trans("fof-ban-ips.admin.page.date_label")),m("th",null))),m("tbody",null,a().store.all("banned_ips").slice(this.page,this.page+this.pageSize).map((function(t){return D.component({bannedIP:t})})))):m("div",null,f().component({text:a().translator.trans("fof-ban-ips.admin.empty_text")})))),m("div",null,t,n))},s.refresh=function(){return this.loadResults().then(this.parseResults.bind(this))},s.loadResults=function(){var t=this.page*this.pageSize;return a().store.find("fof/ban-ips",{page:{offset:t,limit:this.pageSize}})},s.loadNext=function(){!0===this.nextResults&&(this.page++,this.refresh())},s.loadPrev=function(){!0===this.prevResults&&(this.page--,this.refresh())},s.parseResults=function(t){this.loading=!1,this.nextResults=!!t.payload.links.next,this.prevResults=!!t.payload.links.prev,m.redraw()},n}(v());const Z={"fof/ban-ips/components/BanIPModal":z,"fof/ban-ips/components/UnbanIPModal":R,"fof/ban-ips/models/BannedIP":l},T=Object.assign(Z,{"fof/ban-ips/components/BanIPModal":U,"fof/ban-ips/components/ChangeReasonModal":j,"fof/ban-ips/components/SettingsPage":E,"fof/ban-ips/components/SettingsPageItem":D}),q=flarum.core;a().initializers.add("fof/ban-ips",(function(){a().store.models.banned_ips=l,a().store.models.users.prototype.bannedIPs=i().hasMany("banned_ips"),a().extensionData.for("fof-ban-ips").registerPermission({icon:"fas fa-gavel",label:a().translator.trans("fof-ban-ips.admin.permissions.view_banned_ip_list_label"),permission:"fof.ban-ips.viewBannedIPList"},"moderate").registerPermission({icon:"fas fa-gavel",label:a().translator.trans("fof-ban-ips.admin.permissions.ban_ip_label"),permission:"fof.ban-ips.banIP"},"moderate").registerPage(E)})),Object.assign(q.compat,T)})(),module.exports=n})();
//# sourceMappingURL=admin.js.map