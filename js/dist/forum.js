(()=>{var t={n:s=>{var n=s&&s.__esModule?()=>s.default:()=>s;return t.d(n,{a:n}),n},d:(s,n)=>{for(var a in n)t.o(n,a)&&!t.o(s,a)&&Object.defineProperty(s,a,{enumerable:!0,get:n[a]})},o:(t,s)=>Object.prototype.hasOwnProperty.call(t,s)};(()=>{"use strict";const s=flarum.core.compat["forum/app"];var n=t.n(s);const a=flarum.core.compat["common/Model"];var o=t.n(a);const e=flarum.core.compat["common/extend"],r=flarum.core.compat["forum/utils/PostControls"];var i=t.n(r);const d=flarum.core.compat["forum/utils/UserControls"];var p=t.n(d);const u=flarum.core.compat["common/components/Button"];var l=t.n(u);function h(t,s){return h=Object.setPrototypeOf||function(t,s){return t.__proto__=s,t},h(t,s)}function c(t,s){t.prototype=Object.create(s.prototype),t.prototype.constructor=t,h(t,s)}const b=flarum.core.compat["common/app"];var f=t.n(b);const _=flarum.core.compat["common/components/Modal"];var y=t.n(_);const v=flarum.core.compat["common/components/Alert"];var O=t.n(v);const g=flarum.core.compat["common/utils/Stream"];var P=t.n(g);const B=flarum.core.compat["common/helpers/punctuateSeries"];var I=t.n(B),U=function(t){function s(){return t.apply(this,arguments)||this}c(s,t);var n=s.prototype;return n.oninit=function(s){if(t.prototype.oninit.call(this,s),this.address=this.attrs.address,this.post=this.attrs.post,this.user=this.attrs.user||this.post&&this.post.user(),!this.user&&this.address){var n=f().store.getBy("banned_ips","address",this.address);n&&(this.user=n.user())}this.banOptions=[],(this.post&&this.post.ipAddress()||this.address)&&this.banOptions.push("only"),this.user&&this.banOptions.push("all"),this.banOption=P()(this.banOptions[0]),this.reason=P()(""),this.otherUsers={},this.loading=!1},n.className=function(){return"Modal--medium"},n.title=function(){return f().translator.trans("fof-ban-ips.lib.modal.title")},n.content=function(){var t=this,s=this.otherUsers[this.banOption()],n=s&&s.map((function(t){return t&&t.displayName()||f().translator.trans("core.lib.username.deleted_text")}));return m("div",{className:"Modal-body"},m("p",null,f().translator.trans("fof-ban-ips.lib.modal.ban_ip_confirmation")),m("div",{className:"Form-group"},this.banOptions.map((function(s){return m("div",null,m("input",{type:"radio",name:"ban-option",id:"ban-option-"+s,checked:t.banOption()===s,onclick:t.banOption.bind(t,s)})," ",m("label",{htmlFor:"ban-option-"+s},f().translator.trans("fof-ban-ips.forum.modal.ban_options_"+s+"_ip",{user:t.user,ip:t.address||t.post&&t.post.ipAddress()})))}))),m("div",{className:"Form-group"},m("label",{className:"label"},f().translator.trans("fof-ban-ips.lib.modal.reason_label")),m("input",{type:"text",className:"FormControl",bidi:this.reason})),s?s.length?O().component({dismissible:!1},f().translator.trans("fof-ban-ips.lib.modal.ban_ip_users",{users:I()(n),count:n.length})):O().component({dismissible:!1,type:"success"},f().translator.trans("fof-ban-ips.forum.modal.ban_ip_no_users")):"",s&&m("br",null),m("div",{className:"Form-group"},m(l(),{className:"Button Button--primary",type:"submit",loading:this.loading},n?f().translator.trans("fof-ban-ips.lib.modal.ban_button"):f().translator.trans("fof-ban-ips.lib.modal.check_button"))))},n.onsubmit=function(t){var s=this;if(t.preventDefault(),this.loading=!0,void 0===this.otherUsers[this.banOption()])return this.getOtherUsers();var n={reason:this.reason(),userId:this.user.id()};"only"===this.banOption()?(n.address=this.post.ipAddress(),f().store.createRecord("banned_ips").save(n).then(this.hide.bind(this)).catch(this.onerror.bind(this)).then(this.loaded.bind(this))):"all"===this.banOption()&&f().request({body:{data:{attributes:n}},url:""+f().forum.attribute("apiUrl")+this.user.apiEndpoint()+"/ban",method:"POST",errorHandler:this.onerror.bind(this)}).then((function(t){return f().store.pushPayload(t).forEach(s.done.bind(s))})).then(this.hide.bind(this)).catch((function(){})).then(this.loaded.bind(this))},n.getOtherUsers=function(){var t=this,s={};"only"===this.banOption()&&(s.ip=this.address||this.post.ipAddress()),f().request({params:s,url:f().forum.attribute("apiUrl")+"/fof/ban-ips/check-users/"+this.user.id(),method:"GET",errorHandler:this.onerror.bind(this)}).then((function(s){t.otherUsers[t.banOption()]=s.data.map((function(t){return f().store.pushObject(t)})).filter((function(t){return 0===t.bannedIPs().length})),t.loading=!1})).catch((function(){})).then(this.loaded.bind(this))},n.done=function(t){var s={type:"banned_ips",id:t.id()};this.post&&(this.post.data.relationships.banned_ip={data:s}),this.user.data.relationships.banned_ips||(this.user.data.relationships.banned_ips={data:[]}),this.user.data.relationships.banned_ips.data.push(s),this.user.data.attributes.isBanned=!0,f().store.pushObject(this.user.data)},s}(y());flarum.core.compat["common/helpers/username"];var A=function(t){function s(){return t.apply(this,arguments)||this}c(s,t);var n=s.prototype;return n.title=function(){return f().translator.trans("fof-ban-ips.lib.modal.unban_title")},n.content=function(){var t=this,s=this.otherUsers[this.banOption()],n=s&&s.map((function(t){return t&&t.displayName()||f().translator.trans("core.lib.username.deleted_text")}));return this.bannedIPs?m("div",{className:"Modal-body"},O().component({dismissible:!1,type:"success"},f().translator.trans("fof-ban-ips.lib.modal.unbanned_ips",{ips:I()(this.bannedIPs)}))):m("div",{className:"Modal-body"},m("p",null,f().translator.trans("fof-ban-ips.lib.modal.unban_ip_confirmation")),m("div",{className:"Form-group"},this.banOptions.map((function(s){return m("div",null,m("input",{type:"radio",name:"ban-option",id:"ban-option-"+s,checked:t.banOption()===s,onclick:t.banOption.bind(t,s)})," ",m("label",{htmlFor:"ban-option-"+s},f().translator.trans("fof-ban-ips.lib.modal.unban_options_"+s+"_ip",{user:t.user,ip:t.address||t.post&&t.post.ipAddress()})))}))),s?s.length?O().component({dismissible:!1},f().translator.trans("fof-ban-ips.lib.modal.unban_ip_users",{users:I()(n),count:n.length})):O().component({dismissible:!1,type:"success"},f().translator.trans("fof-ban-ips.lib.modal.unban_ip_no_users")):"",s&&m("br",null),m("div",{className:"Form-group"},m(l(),{className:"Button Button--primary",type:"submit",loading:this.loading},n?f().translator.trans("fof-ban-ips.lib.modal.unban_button"):f().translator.trans("fof-ban-ips.lib.modal.check_button"))))},n.onsubmit=function(t){if(t.preventDefault(),this.loading=!0,void 0===this.otherUsers[this.banOption()])return this.getOtherUsers();var s={};if("only"===this.banOption()){s.address=this.address||this.post.ipAddress();var n=this.post?this.post.bannedIP():f().store.getBy("banned_ips","address",this.address);n.delete().then(this.done.bind(this,n)).catch(this.onerror.bind(this)).then(this.hide.bind(this))}else"all"===this.banOption()&&f().request({body:{data:{attributes:s}},url:""+f().forum.attribute("apiUrl")+this.user.apiEndpoint()+"/unban",method:"POST",errorHandler:this.onerror.bind(this)}).then(this.done.bind(this)).catch(this.onerror.bind(this)).then(this.hide.bind(this))},n.getOtherUsers=function(){var t=this,s={};"only"===this.banOption()&&(s.ip=this.address||this.post.ipAddress(),s.skipValidation=!0);var n=f().forum.attribute("apiUrl")+"/fof/ban-ips/check-users";this.user&&(n+="/"+this.user.id()),f().request({params:s,url:n,method:"GET",errorHandler:this.onerror.bind(this)}).then((function(s){var n=f().store.pushPayload(s);t.otherUsers[t.banOption()]=n.filter((function(t){return 1===t.bannedIPs().length})),t.loading=!1,m.redraw()})).catch((function(){})).then(this.loaded.bind(this))},n.done=function(t){this.loading=!1,this.post&&delete this.post.data.relationships.banned_ip,!this.user||this.user.data.relationships||t?this.user&&t instanceof f().store.models.banned_ips&&(this.user.data.relationships.banned_ips={data:this.user.data.relationships.banned_ips.data.filter((function(s){return s.id!==t.id()}))},this.user.data.attributes.isBanned=0!==this.user.data.relationships.banned_ips.data.length):(this.user.data.relationships.banned_ips.data=[],this.user.data.attributes.isBanned=!1),t&&Array.isArray(t.data)&&(this.bannedIPs=t.data.map((function(t){return t.attributes.address})),this.loading=!1,m.redraw())},n.hide=function(){t.prototype.hide.call(this),this.attrs.redraw||location.reload()},s}(U);const N=flarum.core.compat["common/utils/mixin"];var k=function(t){function s(){return t.apply(this,arguments)||this}return c(s,t),s.prototype.apiEndpoint=function(){return"/fof/ban-ips"+(this.exists?"/"+this.id():"")},s}(t.n(N)()(o(),{creator:o().hasOne("creator"),user:o().hasOne("user"),address:o().attribute("address"),reason:o().attribute("reason"),createdAt:o().attribute("createdAt",o().transformDate),deletedAt:o().attribute("deletedAt",o().transformDate)}));const x=flarum.core.compat["common/models/User"];var M=t.n(x);const F=flarum.core.compat["common/components/Badge"];var j=t.n(F);const w={"fof/ban-ips/components/BanIPModal":U,"fof/ban-ips/components/UnbanIPModal":A,"fof/ban-ips/models/BannedIP":k},E=flarum.core;n().initializers.add("fof/ban-ips",(function(){n().store.models.posts.prototype.canBanIP=o().attribute("canBanIP"),n().store.models.posts.prototype.ipAddress=o().attribute("ipAddress"),n().store.models.posts.prototype.bannedIP=o().hasOne("banned_ip"),n().store.models.users.prototype.canBanIP=o().attribute("canBanIP"),n().store.models.users.prototype.isBanned=o().attribute("isBanned"),n().store.models.users.prototype.bannedIPs=o().hasMany("banned_ips"),n().store.models.banned_ips=k,(0,e.extend)(i(),"userControls",(function(t,s){if(s&&s.user()){var a=s.user().isBanned(),o=a?"un":"";s.canBanIP()&&!s.isHidden()&&s.user()!==n().session.user&&"comment"===s.contentType()&&t.add(o+"ban",l().component({icon:"fas fa-gavel",onclick:function(){return n().modal.show(a?A:U,{post:s})}},n().translator.trans("fof-ban-ips.forum."+o+"ban_ip_button")))}})),(0,e.extend)(p(),"moderationControls",(function(t,s){if(s.canBanIP()&&s!==n().session.user){var a=s.isBanned(),o=a?"un":"";t.add(o+"ban",l().component({icon:"fas fa-gavel",onclick:function(){return n().modal.show(a?A:U,{user:s})}},n().translator.trans("fof-ban-ips.forum.user_controls."+o+"ban_button")))}})),(0,e.extend)(M().prototype,"badges",(function(t){this.isBanned()&&t.add("banned",j().component({icon:"fas fa-gavel",type:"banned",label:n().translator.trans("fof-ban-ips.forum.user_badge.banned_tooltip")}))}))})),Object.assign(E.compat,w)})(),module.exports={}})();
//# sourceMappingURL=forum.js.map